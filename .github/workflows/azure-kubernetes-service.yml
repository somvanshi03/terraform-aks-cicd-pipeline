name: Deploy to AKS with Helm (inputs: image tag + optional service port)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target namespace/environment"
        required: true
        default: "dev"
        type: choice
        options: [dev, qa, stage, uat, prod]

      image_tag:
        description: "Docker image tag to deploy (required)"
        required: true
        type: string

      service_port:
        description: "Service port (optional). Leave empty to use chart default."
        required: false
        default: ""
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------
      # Azure Login (Service Principal)
      # ---------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      # ---------------------------
      # Set AKS Context
      # ---------------------------
      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

      # ---------------------------
      # Setup Helm
      # ---------------------------
      - name: Setup Helm
        uses: azure/setup-helm@v4

      # ---------------------------
      # Deploy with Helm
      # ---------------------------
      - name: Helm upgrade/install
        env:
          NAMESPACE: ${{ github.event.inputs.environment }}
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}
          SERVICE_PORT: ${{ github.event.inputs.service_port }}
        run: |
          set -euo pipefail

          if [ -z "$IMAGE_TAG" ]; then
            echo "ERROR: image_tag is required"
            exit 1
          fi

          RELEASE_NAME="my-app"
          CHART_PATH="./helm/my-app"

          echo "Deploying release: $RELEASE_NAME"
          echo "Namespace:         $NAMESPACE"
          echo "Image tag:         $IMAGE_TAG"
          if [ -n "$SERVICE_PORT" ]; then
            echo "Service port:      $SERVICE_PORT (override)"
          else
            echo "Service port:      (using chart default)"
          fi

          # Base helm args (always set image tag)
          HELM_ARGS=(
            upgrade --install "$RELEASE_NAME" "$CHART_PATH"
            --namespace "$NAMESPACE"
            --create-namespace
            --set "image.tag=$IMAGE_TAG"
            --atomic
            --timeout 10m
          )

          # Optional: override service port only if user provided it
          # Change 'service.port' if your chart uses a different key.
          if [ -n "$SERVICE_PORT" ]; then
            # Basic numeric validation
            if ! echo "$SERVICE_PORT" | grep -Eq '^[0-9]+$'; then
              echo "ERROR: service_port must be a number (got: $SERVICE_PORT)"
              exit 1
            fi
            HELM_ARGS+=( --set "service.port=$SERVICE_PORT" )
          fi

          helm "${HELM_ARGS[@]}"

      # ---------------------------
      # Verify rollout (optional)
      # ---------------------------
      - name: Verify rollout
        env:
          NAMESPACE: ${{ github.event.inputs.environment }}
        run: |
          kubectl get deploy,svc -n "$NAMESPACE"
          kubectl get pods -n "$NAMESPACE" -o wide
